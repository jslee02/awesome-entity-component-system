name: Evaluate Submission

on:
  issues:
    types: [labeled]
  schedule:
    - cron: "0 9 1 * *"
  workflow_dispatch:

jobs:
  evaluate:
    if: github.event.label.name == 'suggestion'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - run: pip install pyyaml

      - name: Extract GitHub repo from issue body
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || '';

            // Try the structured "github" field first (from issue template)
            const ghMatch = body.match(/### GitHub Repository\s*\n\s*\n?\s*([a-zA-Z0-9._-]+\/[a-zA-Z0-9._-]+)/);
            if (ghMatch) {
              core.setOutput('repo', ghMatch[1]);
              return;
            }

            // Fallback: extract from any GitHub URL in the body
            const urlMatch = body.match(/github\.com\/([a-zA-Z0-9._-]+\/[a-zA-Z0-9._-]+)/);
            if (urlMatch) {
              core.setOutput('repo', urlMatch[1]);
              return;
            }

            core.setOutput('repo', '');

      - name: Run evaluation
        if: steps.extract.outputs.repo != ''
        id: eval
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPORT=$(python3 scripts/evaluate_entry.py --data-dir data/ "${{ steps.extract.outputs.repo }}" 2>&1) || true
          echo "$REPORT" > /tmp/eval-report.md

          python3 scripts/evaluate_entry.py --data-dir data/ --json "${{ steps.extract.outputs.repo }}" 2>/dev/null > /tmp/eval-result.json || true
          REC=$(python3 -c "import sys,json; print(json.load(open('/tmp/eval-result.json')).get('recommendation','error'))" 2>/dev/null || echo "error")
          ARCHIVED=$(python3 -c "import sys,json; print(str(json.load(open('/tmp/eval-result.json')).get('archived',False)).lower())" 2>/dev/null || echo "false")
          echo "recommendation=$REC" >> "$GITHUB_OUTPUT"
          echo "archived=$ARCHIVED" >> "$GITHUB_OUTPUT"

      - name: Post evaluation comment
        if: steps.extract.outputs.repo != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('/tmp/eval-report.md', 'utf8');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: report
            });

      - name: Apply label and handle outcome
        if: steps.extract.outputs.repo != ''
        uses: actions/github-script@v7
        with:
          script: |
            const rec = '${{ steps.eval.outputs.recommendation }}';
            const archived = '${{ steps.eval.outputs.archived }}' === 'true';
            const issue = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            let label;
            if (rec === 'reject' && archived) {
              label = 'rejected';
            } else {
              const labelMap = {
                'accept': 'accepted',
                'likely_accept': 'accepted',
                'incubator': 'incubator',
                'reject': 'incubator',
                'duplicate': 'duplicate',
                'error': 'needs-review',
              };
              label = labelMap[rec] || 'needs-review';
            }
            await github.rest.issues.addLabels({ owner, repo, issue_number: issue, labels: [label] });

            if (rec === 'duplicate' || (rec === 'reject' && archived)) {
              await github.rest.issues.update({
                owner, repo, issue_number: issue,
                state: 'closed',
                state_reason: 'not_planned',
              });
            }

      - name: Post fallback comment (no repo found)
        if: steps.extract.outputs.repo == ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                'ðŸ‘‹ Thanks for the suggestion!',
                '',
                'I couldn\'t find a GitHub repository in this issue. Could you add the **GitHub Repository** field ',
                '(e.g., `owner/repo`) so I can run an automated evaluation?',
                '',
                'If the project isn\'t on GitHub, no worries â€” a maintainer will review it manually.',
              ].join('\n')
            });
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['needs-review']
            });

  re-evaluate:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - run: pip install pyyaml

      - name: Re-evaluate incubator issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'incubator',
              state: 'open',
              per_page: 50,
            });

            for (const issue of issues.data) {
              const body = issue.body || '';
              const ghMatch = body.match(/### GitHub Repository\s*\n\s*\n?\s*([a-zA-Z0-9._-]+\/[a-zA-Z0-9._-]+)/);
              const urlMatch = body.match(/github\.com\/([a-zA-Z0-9._-]+\/[a-zA-Z0-9._-]+)/);
              const repo = ghMatch ? ghMatch[1] : urlMatch ? urlMatch[1] : null;
              if (!repo) continue;

              let result;
              try {
                const json = execSync(
                  `python3 scripts/evaluate_entry.py --data-dir data/ --json "${repo}"`,
                  { encoding: 'utf8', timeout: 30000 }
                );
                result = JSON.parse(json);
              } catch (e) {
                continue;
              }

              const rec = result.recommendation || 'error';
              if (rec === 'accept' || rec === 'likely_accept') {
                const report = execSync(
                  `python3 scripts/evaluate_entry.py --data-dir data/ "${repo}"`,
                  { encoding: 'utf8', timeout: 30000 }
                );
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: 'â™»ï¸ **Monthly re-evaluation** â€” this project now qualifies!\n\n' + report,
                });
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['accepted'],
                });
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  name: 'incubator',
                }).catch(() => {});
              }
            }
